# =============================================================================
# Futures Trading Co-Pilot — Docker Compose (5-Service Architecture)
# =============================================================================
#
# Services:
#   postgres       — durable storage (journal, historical opts, alerts)
#   redis          — hot cache (latest FKS metrics, live positions, 1m bars)
#   data-service   — FastAPI API layer (reads from Redis, serves to UI)
#   engine         — background computation (FKS, optimization, backtesting)
#   streamlit-app  — pure UI client (reads from data-service + Redis)
#
# Usage:
#   docker compose up -d --build
#   docker compose logs -f engine
#   docker compose ps
#
# =============================================================================

services:
    # -------------------------------------------------------------------------
    # PostgreSQL — durable storage
    # -------------------------------------------------------------------------
    postgres:
        image: postgres:16-alpine
        restart: unless-stopped
        ports:
            - "5432:5432"
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-futures_user}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-futures_dev_pass}
            POSTGRES_DB: ${POSTGRES_DB:-futures_db}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER:-futures_user} -d ${POSTGRES_DB:-futures_db}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

    # -------------------------------------------------------------------------
    # Redis — hot cache for real-time data
    # -------------------------------------------------------------------------
    redis:
        image: redis:7-alpine
        restart: unless-stopped
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 3

    # -------------------------------------------------------------------------
    # Data Service — FastAPI API layer (thin)
    # Serves REST API, reads computed results from Redis cache.
    # ENGINE_MODE=remote means it does NOT run heavy computation itself.
    # -------------------------------------------------------------------------
    data:
        build:
            context: .
            dockerfile: docker/data/Dockerfile
        restart: unless-stopped
        ports:
            - "8000:8000"
        env_file:
            - .env
        environment:
            - REDIS_URL=redis://redis:6379/0
            - DATABASE_URL=postgresql+psycopg://${POSTGRES_USER:-futures_user}:${POSTGRES_PASSWORD:-futures_dev_pass}@postgres:5432/${POSTGRES_DB:-futures_db}
            - DB_PATH=/app/data/futures_journal.db
            - DATA_SERVICE_HOST=0.0.0.0
            - DATA_SERVICE_PORT=8000
            - ENGINE_MODE=remote
            - PYTHONPATH=/app/src:/app/src/services/data:/app
            - PYTHONUNBUFFERED=1
        volumes:
            - app_data:/app/data
        depends_on:
            redis:
                condition: service_healthy
            postgres:
                condition: service_healthy
        healthcheck:
            test:
                [
                    "CMD",
                    "python",
                    "-c",
                    "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
                ]
            interval: 15s
            timeout: 5s
            start_period: 30s
            retries: 3

    # -------------------------------------------------------------------------
    # Engine — Background computation worker
    # Heavy: DashboardEngine, FKS modules, optimization, backtesting,
    # Massive WebSocket, wave analysis, volatility, signal quality, regime,
    # CVD, ICT. Reads data from Massive/Redis, writes results to Redis.
    # -------------------------------------------------------------------------
    engine:
        build:
            context: .
            dockerfile: docker/engine/Dockerfile
        restart: unless-stopped
        env_file:
            - .env
        environment:
            - REDIS_URL=redis://redis:6379/0
            - DATABASE_URL=postgresql+psycopg://${POSTGRES_USER:-futures_user}:${POSTGRES_PASSWORD:-futures_dev_pass}@postgres:5432/${POSTGRES_DB:-futures_db}
            - DB_PATH=/app/data/futures_journal.db
            - PYTHONPATH=/app/src:/app/src/services/engine:/app
            - PYTHONUNBUFFERED=1
        volumes:
            - app_data:/app/data
        depends_on:
            redis:
                condition: service_healthy
            postgres:
                condition: service_healthy

    # -------------------------------------------------------------------------
    # Streamlit App — pure UI client (fast reloads)
    # Calls data-service API + reads Redis directly for ultra-low latency
    # -------------------------------------------------------------------------
    app:
        build:
            context: .
            dockerfile: docker/web/Dockerfile
        restart: unless-stopped
        ports:
            - "8501:8501"
        env_file:
            - .env
        environment:
            - REDIS_URL=redis://redis:6379/0
            - DATA_SERVICE_URL=http://data:8000
            - DATABASE_URL=postgresql+psycopg://${POSTGRES_USER:-futures_user}:${POSTGRES_PASSWORD:-futures_dev_pass}@postgres:5432/${POSTGRES_DB:-futures_db}
            - DB_PATH=/app/data/futures_journal.db
            - PYTHONPATH=/app/src:/app
            - PYTHONUNBUFFERED=1
        volumes:
            - app_data:/app/data
        depends_on:
            redis:
                condition: service_healthy
            data:
                condition: service_healthy
        healthcheck:
            test:
                [
                    "CMD",
                    "python",
                    "-c",
                    "import urllib.request; urllib.request.urlopen('http://localhost:8501/_stcore/health')",
                ]
            interval: 15s
            timeout: 5s
            start_period: 15s
            retries: 3

volumes:
    postgres_data:
    redis_data:
    app_data:
